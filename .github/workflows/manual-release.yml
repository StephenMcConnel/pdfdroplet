name: Manual Release Build

on:
    workflow_dispatch:
        inputs:
            prerelease:
                description: "Mark the release as a pre-release."
                required: false
                type: boolean
                default: false

jobs:
    build-and-release:
        name: Build and publish installer
        runs-on: windows-latest
        permissions:
            contents: write
        env:
            PROJECT_PATH: src/PdfDroplet.csproj
            BUILD_CONFIGURATION: Release
            RUNTIME_IDENTIFIER: win-x86
            PUBLISH_DIR: publish
            # SDK used to build; project target version remains defined in Directory.Build.props / csproj
            DOTNET_VERSION: "8.0.x"
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Setup Inno Setup
              uses: crazy-max/ghaction-setup-inno@v3
              with:
                  version: "6.2.2"

            - name: Determine version
              id: version
              shell: pwsh
              run: |
                  $propsPath = Join-Path $env:GITHUB_WORKSPACE 'Directory.Build.props'
                  if (-not (Test-Path $propsPath)) {
                    throw "Directory.Build.props not found at $propsPath"
                  }
                  [xml]$props = Get-Content $propsPath
                  $version = $props.Project.PropertyGroup.Version
                  if ([string]::IsNullOrWhiteSpace($version)) {
                    throw 'Version property not found in Directory.Build.props'
                  }
                  "value=$version" >> $env:GITHUB_OUTPUT

            - name: Normalize installer version
              id: installer_version
              shell: pwsh
              run: |
                  $raw = '${{ steps.version.outputs.value }}'
                  if ([string]::IsNullOrWhiteSpace($raw)) {
                    throw 'Version step did not provide a value.'
                  }
                  $segments = $raw.Split('.')
                  while ($segments.Count -lt 3) {
                    $segments += '0'
                  }
                  if ($segments.Count -gt 3) {
                    $segments = $segments[0..2]
                  }
                  $normalized = [string]::Join('.', $segments)
                  "value=$normalized" >> $env:GITHUB_OUTPUT

            - name: Restore dependencies
              run: dotnet restore $env:PROJECT_PATH --runtime $env:RUNTIME_IDENTIFIER

            - name: Build
              run: dotnet build $env:PROJECT_PATH --configuration $env:BUILD_CONFIGURATION --no-restore --runtime $env:RUNTIME_IDENTIFIER /p:Platform=x86

            - name: Build Inno Setup installer
              shell: pwsh
              run: |
                  $installerVersion = '${{ steps.installer_version.outputs.value }}'
                  if ([string]::IsNullOrWhiteSpace($installerVersion)) {
                    throw 'Installer version could not be determined.'
                  }
                  # Update version in Inno Setup script
                  $issPath = Join-Path $env:GITHUB_WORKSPACE 'PdfDroplet.iss'
                  $issContent = Get-Content $issPath -Raw
                  $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$installerVersion`""
                  Set-Content $issPath $issContent -NoNewline

                  # Compile the installer
                  iscc.exe PdfDroplet.iss

            - name: Prepare installer asset
              id: installer
              shell: pwsh
              run: |
                  $version = '${{ steps.installer_version.outputs.value }}'
                  if ([string]::IsNullOrWhiteSpace($version)) {
                    throw 'Installer version output missing.'
                  }
                  $source = Join-Path $env:GITHUB_WORKSPACE 'output\installer\PdfDropletInstaller.exe'
                  if (-not (Test-Path $source)) {
                    throw "Expected installer at $source"
                  }
                  $artifactName = "PdfDropletInstaller-$version"
                  $destination = Join-Path (Split-Path $source -Parent) ("$artifactName.exe")
                  Copy-Item $source $destination -Force
                  "artifact_name=$artifactName" >> $env:GITHUB_OUTPUT
                  "installer_path=$destination" >> $env:GITHUB_OUTPUT

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.installer.outputs.artifact_name }}
                  path: ${{ steps.installer.outputs.installer_path }}

            - name: Resolve release metadata
              id: release
              shell: pwsh
              run: |
                  $version = '${{ steps.version.outputs.value }}'
                  if ([string]::IsNullOrWhiteSpace($version)) {
                    throw 'Version step did not provide a value.'
                  }
                  $tag = "v$version"
                  $name = "PdfDroplet $version"
                  $notes = "Automated release generated from the Manual Release Build workflow, including the Windows installer built with Inno Setup."
                  "tag_name=$tag" >> $env:GITHUB_OUTPUT
                  "release_name=$name" >> $env:GITHUB_OUTPUT
                  "body=$notes" >> $env:GITHUB_OUTPUT

            - name: Create GitHub release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.release.outputs.tag_name }}
                  release_name: ${{ steps.release.outputs.release_name }}
                  body: ${{ steps.release.outputs.body }}
                  draft: true
                  prerelease: ${{ inputs.prerelease }}

            - name: Upload release asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ${{ steps.installer.outputs.installer_path }}
                  asset_name: ${{ steps.installer.outputs.artifact_name }}.exe
                  asset_content_type: application/octet-stream
